<?xml version="1.0" encoding="UTF-8"?>
<project name="portal-app" default="all">

    <import file="portal-app.xml"/>

    <target name="copyLibs">
        <copy todir="build/WEB-INF/lib">
            <path refid="toolkit.module.production.classpath"></path>
        </copy>

        <copy todir="build/WEB-INF/lib">
            <path refid="portal-app.module.production.classpath"></path>
        </copy>

        <delete file="build/WEB-INF/lib/el-api-*.jar"></delete>
        <delete file="build/WEB-INF/lib/servlet-api-*.jar"></delete>
        <delete>
            <fileset dir="build/WEB-INF/lib" includes="**/jetty-*.jar"/>
        </delete>
    </target>

    <target name="clean-dist">
        <delete dir="dist" failonerror="true"/>

    </target>

    <target name="toolkit-jar" description="toolkit jar">
        <zip basedir="${toolkit.output.dir}" file="build/WEB-INF/lib/toolkit.jar"
             excludes="**/toolkit/jetty/**, **/toolkit/test/**"/>
    </target>

    <target name="--prepare-build" depends="clean, clean-dist, all, toolkit-jar, copyLibs">
    </target>

    <target name="--prepare-war">

        <jar destfile="build/WEB-INF/lib/portal-app.jar"
             basedir="${portal-app.output.dir}"
             excludes="**/*beans-*.xml, **/portal/test/**"/>

        <copy file="webapp/WEB-INF/web.xml"
              tofile="build/WEB-INF/web.xml"
              overwrite="true"/>

        <copy file="webapp/WEB-INF/jetty-web.xml"
              tofile="build/WEB-INF/jetty-web.xml"
              overwrite="true"/>

    </target>


    <target name="build-prod" depends="--prepare-build">
        <copy file="src/META-INF/beans-prod.xml"
              tofile="${portal-app.output.dir}/META-INF/beans.xml"
              overwrite="true" failonerror="true"/>
        <copy file="webapp/WEB-INF/persistence-pg.properties"
              tofile="build/WEB-INF/persistence.properties"
              overwrite="true"/>
        <antcall target="--prepare-war"/>
        <war basedir="build" file="dist/portal.war"/>
        <delete dir="build"/>
    </target>


    <target name="build-deploy-mock" depends="--prepare-build">
        <copy file="src/META-INF/beans-deploy-mock.xml"
              tofile="${portal-app.output.dir}/META-INF/beans.xml"
              overwrite="true" failonerror="true"/>
        <antcall target="--prepare-war"/>
        <war basedir="build" file="dist/portal.war"/>
        <delete dir="build"/>
    </target>


</project>